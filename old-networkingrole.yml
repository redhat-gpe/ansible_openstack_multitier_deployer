---
- when: openstack_networks is not defined
  name: openstack_networks is not defined
  debug:
    msg: openstack_networks is not defined

- when: openstack_networks is defined
  name: Manage openstack networks
  block: 

    - name: Manage configuration of Public and Private Networks
      os_network:
        cloud:                        "{{ __openstack_network.cloud_name }}"
        state:                        "{{ __openstack_network.state }}"
        name:                         "{{ __openstack_network.network_name }}"
        external:                     "{{ __openstack_network.external }}"
        admin_state_up:               "{{ __openstack_network.admin_state }}"
        provider_network_type:        "{{ __openstack_network.provider_network_type | default(omit) }}"
        provider_physical_network:    "{{ __openstack_network.provider_physical_network | default(omit) }}"
      loop: "{{ openstack_networks }}"
      loop_control:
        loop_var: __openstack_network

    - name: Manage configuration of Subnets for Public and Private SubNets
      os_subnet:
        cloud:                        "{{ __openstack_network.cloud_name }}"
        state:                        "{{ __openstack_network.state }}"
        network_name:                 "{{ __openstack_network.network_name  }}"
        name:                         "{{ __openstack_network.subnet_name  }}"
        cidr:                         "{{ __openstack_network.cidr_network }}"
        ip_version:                   "{{ __openstack_network.ip_version }}"
        gateway_ip:                   "{{ __openstack_network.gateway_ip | default(omit) }}"
        enable_dhcp:                  "{{ __openstack_network.enable_dhcp }}"
        allocation_pool_start:        "{{ __openstack_network.allocation_pool_start | default(omit) }}"
        allocation_pool_end:          "{{ __openstack_network.allocation_pool_end | default(omit) }}"
        dns_nameservers:
          - 8.8.8.8
          - 8.8.8.7
      loop: "{{ openstack_networks }}"
      loop_control:
        loop_var: __openstack_network

    - name: Lookup name of external subnet 
      os_subnets_info:
        cloud: "{{ openstack_cloud }}"
        name: "{{ network_prefix }}*"
      vars:
        network_prefix: "{{ openstack_external_network_name }}"
      register: r_subnets

    - name: Store name of external subnet
      set_fact:
        f_external_subnet_name: "{{ r_subnets.openstack_subnets[0].name }}"

    - name: Manage OpenStack Routers
      os_router:
        cloud:                        "{{ __openstack_router.cloud_name }}"
        state:                        "{{ __openstack_router.state }}"
        name:                         "{{ __openstack_router.name }}"
        network:                      "{{ __openstack_router.network }}"
        external_fixed_ips:
          - subnet: "{{  f_external_subnet_name }}"

        interfaces:
          - "subnet-52-117-178-0-24"
          - "external-52-118-31-0"
          - "int_subnet"
          - "tok-osp-08-internal-subnet"
          #- "f131ac3f-fac5-4f56-ae56-7dd0afef4838
          # - "{{ __openstack_router.interfaces }}"
      loop: "{{ openstack_routers }}"
      loop_control:
        loop_var: __openstack_router

  tags:
    - openstack-networks
...    
